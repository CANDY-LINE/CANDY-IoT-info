[🔙目次ページへ戻る](README.md)

# CANDY IoTのセットアップ (candy-iot-serviceのインストール)

CANDY IoT付属のアンテナを2本ともCANDY IoT上のLTEモジュールに接続します。続けて、SIMカードを差し込みます。SIMカードは、金色の金属面が基板に接触するようにして取り付けます。

これで準備が整いました。それでは、CANDY IoTの電源用USBケーブルを接続してEdisonを起動させましょう。すでに起動していた場合は、そのままで構いません。

Edisonが起動したら、シリアルコンソールか、SSH接続を行います。

接続後、試しに以下のようなcURLコマンドを実行してみましょう。

```bash
$ curl -i -L --head http://www.candy-line.io/
```

下記のように`HTTP/1.1 200 OK`と出ていれば問題ありません。
```bash
HTTP/1.1 200 OK
Server: nginx
Date: Wed, 21 Sep 2016 08:59:11 GMT
Content-Type: text/html
Content-Length: 14894
Connection: keep-alive
X-Accel-Version: 0.01
Last-Modified: Wed, 10 Aug 2016 02:57:22 GMT
ETag: "3a2e-539aeceef50f6"
Accept-Ranges: bytes
Vary: Accept-Encoding
```

それでは、GitHub上にあるスクリプトをダウンロードしてインストールします。

以下のコマンドを実行します（`git.io`もGitHubの管理するドメインの1つです）。

```bash
$ curl -L https://git.io/vgKTM | bash
```

[CANDY RED](https://github.com/dbaba/candy-red)を **インストールしない場合** は、以下のように`CANDY_RED=0`を指定します。
```bash
$ curl -L https://git.io/vKyOf | CANDY_RED=0 bash
```

また、candy-iot-serviceの特定のバージョンを利用する場合は、以下のようにバージョンを指定することができます。なお、[CANDY RED](https://github.com/dbaba/candy-red)については、常に最新のバージョンのものだけを利用することができます。
```bash
$ VERSION=1.2.3 && \
  curl -L https://raw.githubusercontent.com/CANDY-LINE/candy-iot-service/${VERSION}/install.sh | \
  bash
```

実行すると以下のように表示されます。

    % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                   Dload  Upload   Total   Spent    Left  Speed
    0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0
    100  4566  100  4566    0     0   1873      0  0:00:02  0:00:02 --:--:--  9280
               :
               :
    [INFO] cdc_ether has been installed
    [INFO] Installing CANDY RED...
               :
               :
    [INFO] candy-iot service has been installed
    [ALERT] *** Please reboot the system! (enter 'reboot') ***

なおインストールには、環境によりますが15分〜20分程度かかります。もし処理が止まっているように見えても途中で中断をしないようにしてください。

## インストール後の作業
インストールした後は、以下のコマンドを実行して再起動させましょう。

```bash
$ sudo reboot
```

---
**【ご注意】 シリアルコンソールログイン時のエラーメッセージ**

シリアルコンソールからログインすると以下のようなメッセージが出ることがあります。

    [   31.550057] pl2303 ttyUSB0: pl2303_open - failed submitting interrupt urb, error -22
    [   31.659345] pl2303 ttyUSB0: pl2303_open - failed submitting interrupt urb, error -22

これは、Yoctoのドライバーが出しているメッセージですが、動作に支障はありませんので無視するようにしてください。
このメッセージは、candy-iot-serviceがシリアルポートへアクセスしようとしている際に発生しています。しかし、このメッセージ自体はYoctoのシステムが出しているものであるため、candy-iot-serviceなどのソフトウェアでは止めることができないようになっています。
---

再起動後しばらくすると、[CANDY IoT](http://www.candy-line.io/proandsv.html#candyiot)のオレンジ色のLEDのうちの1つが点滅します。これはモデムが起動していることを表しています。

もし[CANDY IoT](http://www.candy-line.io/proandsv.html#candyiot)のLEDが点滅していれば、セットアップは完了です！

[CANDY-REDへのブラウザー接続](CANDY-REDへのブラウザー接続.md)のページを参照して、[CANDY RED](https://github.com/dbaba/candy-red)を動かしてみましょう。

もし圏外だったり、アンテナが接続されていなかったりした場合は、モデムは起動できません。
[うまく動かない時は](うまく動かない時は.md)のページ　にモデムが起動しない場合の対処策をまとめていますので、ご確認ください。

また、既定の設定では、U-mobileのAPN設定が反映されます。このため、お使いのSIMカードがU-mobile以外のものである場合は、以下の方法で変更する必要があります。

### APN設定（コマンドライン）

```bash
$ sudo candy apn set -n APN名 -u APNユーザーID -p APNパスワード
```

実行後、登録されているかどうかを以下のコマンドで確認することができます。
```bash
$ sudo candy apn ls
{
  "apns": [
    {
      "apn": "APN名",
      "user": "APNユーザーID",
      "apn_id": "1"
    }
  ]
}
```

なお、パスワードは表示されません。

設定変更を確認したら、再起動を行ってください。再起動すると変更したAPNを利用できるようになります。

```bash
$ sudo reboot
```

APN設定方法には、他にファイルを使用した方法もあります。以下にファイルによる変更方法を記します。

### APN設定（ファイル）

コマンドによるAPN設定のほか、あらかじめJSONファイルにAPNを書いておき、それを読み込ませる方法によってAPN設定を変更することもできます。

まずは以下のようなJSONファイルを作成します。ファイル名は、`boot-apn.json`とし、`/opt/candy-line/candy-iot`ディレクトリーに保存します。
```
{"apn":"APN名","user":"APNユーザーID","password":"APNパスワード"}
```
[こちら](systemd/boot-apn.json)に実際のファイルがあります。

ファイルを作成後、再起動を行ってください。再起動すると変更したAPNを利用できるようになります。ただし、再起動後は`boot-apn.json`が削除されます。これは、コマンドラインによるAPN設定変更が常に上書きされないようにするためです。

* [CANDY REDのインストール方法](CANDY-REDのインストール方法.md)
* [Edisonファームウェア更新方法](Edisonファームウェア更新方法.md)
* [Edisonのセットアップ](Edisonのセットアップ.md)

---
COPYRIGHT © 2016 CANDY LINE, Inc. [CC-BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)
